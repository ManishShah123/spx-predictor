<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPX Dashboard Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
        }

        .title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .current-price {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #3498db;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #ecf0f1;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            background: #3498db;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .trades-table th {
            background: #34495e;
            color: white;
            padding: 12px 8px;
            text-align: left;
        }

        .trades-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .trades-table tr:hover {
            background-color: #f8f9fa;
        }

        .positive { color: #27ae60; font-weight: bold; }
        .negative { color: #e74c3c; font-weight: bold; }

        .status-win {
            background: #d5f4e6;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .status-loss {
            background: #fadbd8;
            color: #e74c3c;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .test-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .test-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
        }

        .test-btn:hover {
            background: #2980b9;
        }

        .trade-suggestion {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .suggestion-header {
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .suggestion-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .suggestion-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .suggestion-card h4 {
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .suggestion-value {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .confidence-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .generate-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .suggestion-details {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }

        .suggestion-details h4 {
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .suggestion-details ul {
            list-style: none;
            padding: 0;
        }

        .suggestion-details li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .suggestion-details li:last-child {
            border-bottom: none;
        }

        .risk-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .risk-low { background: #27ae60; }
        .risk-medium { background: #f39c12; }
        .risk-high { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">🧪 SPX Dashboard Test Page</h1>
        
        <div class="current-price">
            <h2>Current S&P 500 Index</h2>
            <div style="font-size: 2.5em; font-weight: bold;" id="currentPrice">6,259.75</div>
            <div>-20.71 (-0.33%) Today</div>
        </div>

        <div class="test-buttons">
            <button class="test-btn" onclick="testChart()">Test Chart</button>
            <button class="test-btn" onclick="testModal()">Test Modal</button>
            <button class="test-btn" onclick="updatePrice()">Update Price</button>
        </div>

        <!-- Trade Suggestion Section -->
        <div class="trade-suggestion">
            <div class="suggestion-header">
                <span>🎯</span>
                <span>AI-Powered Next Day Trade Suggestion</span>
                <span>🤖</span>
            </div>
            <div id="suggestionContent">
                <p>Generate a high-probability trade recommendation based on current market conditions, volatility patterns, and historical data.</p>
                <button class="generate-btn" onclick="generateTradeSuggestion()">🚀 Generate Tomorrow's Trade</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">81.2%</div>
                <div class="stat-label">Prediction Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">+$18,750</div>
                <div class="stat-label">Monthly P&L</div>
            </div>
            <div class="stat-card" onclick="showTradesModal()" style="border: 3px solid #e74c3c;">
                <div class="stat-value">31</div>
                <div class="stat-label">📊 Successful Trades (CLICK ME)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">78%</div>
                <div class="stat-label">Win Rate</div>
            </div>
        </div>

        <div class="chart-container">
            <h3>📈 SPX Chart Test</h3>
            <canvas id="testChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Modal -->
    <div id="tradesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📊 Trading History</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Recent Trades Summary</h3>
                <p><strong>Total Trades:</strong> 39 | <strong>Win Rate:</strong> 78% | <strong>Total P&L:</strong> +$18,750</p>
                
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Strategy</th>
                            <th>Strikes</th>
                            <th>P&L</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Test data
        const sampleTrades = [
            { date: '2025-07-11', strategy: 'Iron Condor', strikes: '6200/6150/6320/6370', pnl: 160, status: 'win' },
            { date: '2025-07-10', strategy: 'Iron Condor', strikes: '6180/6130/6300/6350', pnl: 155, status: 'win' },
            { date: '2025-07-09', strategy: 'Butterfly', strikes: '6250/6275/6300', pnl: 135, status: 'win' },
            { date: '2025-07-08', strategy: 'Iron Condor', strikes: '6160/6110/6280/6330', pnl: -15, status: 'loss' },
            { date: '2025-07-05', strategy: 'Iron Condor', strikes: '6190/6140/6310/6360', pnl: 210, status: 'win' },
            { date: '2025-07-03', strategy: 'Straddle', strikes: '6250/6250', pnl: -430, status: 'loss' },
            { date: '2025-07-02', strategy: 'Iron Condor', strikes: '6170/6120/6290/6340', pnl: 160, status: 'win' },
            { date: '2025-06-28', strategy: 'Butterfly', strikes: '6240/6265/6290', pnl: 85, status: 'win' }
        ];

        // Market analysis data for trade suggestions
        const marketConditions = {
            vix: 16.8,
            trend: 'bullish',
            support: 6240,
            resistance: 6290,
            momentum: 'positive',
            earnings: false,
            fomc: false,
            expiration: 'friday'
        };

        const strategyTemplates = [
            {
                name: 'Iron Condor',
                type: 'neutral',
                minIV: 15,
                maxIV: 25,
                optimalDTE: [2, 5],
                winRate: 82,
                description: 'Short-term premium collection with quick theta decay',
                riskProfile: 'low',
                frequency: 'daily'
            },
            {
                name: '0DTE Iron Condor',
                type: 'neutral',
                minIV: 12,
                maxIV: 30,
                optimalDTE: [0, 1],
                winRate: 75,
                description: 'Same-day expiration for maximum theta acceleration',
                riskProfile: 'medium',
                frequency: 'intraday'
            },
            {
                name: 'Short Strangle',
                type: 'neutral',
                minIV: 18,
                maxIV: 35,
                optimalDTE: [1, 3],
                winRate: 78,
                description: 'Tight strikes for range-bound market, quick profits',
                riskProfile: 'medium',
                frequency: 'daily'
            },
            {
                name: 'Bull Put Spread',
                type: 'bullish',
                minIV: 12,
                maxIV: 30,
                optimalDTE: [1, 4],
                winRate: 79,
                description: 'Short-term bullish bias with limited risk',
                riskProfile: 'low',
                frequency: 'daily'
            },
            {
                name: 'Bear Call Spread',
                type: 'bearish',
                minIV: 12,
                maxIV: 30,
                optimalDTE: [1, 4],
                winRate: 76,
                description: 'Short-term bearish bias with capped downside',
                riskProfile: 'low',
                frequency: 'daily'
            },
            {
                name: 'Butterfly Spread',
                type: 'neutral',
                minIV: 16,
                maxIV: 28,
                optimalDTE: [1, 3],
                winRate: 81,
                description: 'Precise targeting for minimal movement, fast decay',
                riskProfile: 'low',
                frequency: 'daily'
            },
            {
                name: 'Scalp Straddle',
                type: 'volatility',
                minIV: 8,
                maxIV: 18,
                optimalDTE: [0, 2],
                winRate: 68,
                description: 'Quick volatility plays for intraday moves',
                riskProfile: 'high',
                frequency: 'intraday'
            },
            {
                name: 'Jade Lizard',
                type: 'bullish-neutral',
                minIV: 20,
                maxIV: 35,
                optimalDTE: [2, 4],
                winRate: 73,
                description: 'Undefined risk upside, defined downside, quick theta',
                riskProfile: 'medium',
                frequency: 'daily'
            }
        ];

        // Enhanced market conditions with intraday data
        const enhancedMarketConditions = {
            vix: 16.8,
            trend: 'bullish',
            support: 6240,
            resistance: 6290,
            momentum: 'positive',
            timeOfDay: 'market-open', // market-open, mid-day, power-hour, after-hours
            volumeProfile: 'high',
            gammaExposure: 'positive',
            dailyRange: 0.45, // percentage
            weeklyRange: 1.2,
            earnings: false,
            fomc: false,
            expiration: 'friday',
            marketRegime: 'low-vol-grind' // low-vol-grind, high-vol-chop, trending, mean-revert
        };

        // Generate Trade Suggestion
        function generateTradeSuggestion() {
            console.log('Generating trade suggestion...');
            
            const currentPrice = 6259.75;
            const currentIV = marketConditions.vix;
            const trend = marketConditions.trend;
            
            // Simulate loading
            const suggestionContent = document.getElementById('suggestionContent');
            suggestionContent.innerHTML = '<p>🧠 Analyzing market conditions... Please wait.</p>';
            
            setTimeout(() => {
                const suggestion = analyzeMarketAndSuggestTrade(currentPrice, currentIV, trend);
                displayTradeSuggestion(suggestion);
            }, 2000);
        }

        function analyzeMarketAndSuggestTrade(price, iv, trend) {
            // Enhanced algorithm for short-term, high-frequency trading
            let bestStrategy = null;
            let confidence = 0;
            
            const currentHour = new Date().getHours();
            const marketConditions = enhancedMarketConditions;
            
            // Time-based strategy selection for intraday optimization
            const timeFactors = getTimeBasedFactors(currentHour);
            
            // Filter strategies based on IV and time preferences
            const suitableStrategies = strategyTemplates.filter(strategy => 
                iv >= strategy.minIV && 
                iv <= strategy.maxIV &&
                strategy.optimalDTE[1] <= 5 // Focus on short-term strategies
            );
            
            // Advanced selection based on multiple factors
            if (timeFactors.is0DTE && iv < 25) {
                // 0DTE strategies for same-day expiration
                bestStrategy = suitableStrategies.find(s => s.name === '0DTE Iron Condor') || 
                              suitableStrategies.find(s => s.name === 'Scalp Straddle') ||
                              suitableStrategies[0];
                confidence = 88;
            } else if (marketConditions.marketRegime === 'low-vol-grind' && iv < 20) {
                // Low volatility environment - premium selling
                bestStrategy = suitableStrategies.find(s => s.name === 'Iron Condor') ||
                              suitableStrategies.find(s => s.name === 'Short Strangle') ||
                              suitableStrategies[0];
                confidence = 85;
            } else if (trend === 'bullish' && timeFactors.isMorning) {
                // Morning bullish momentum
                bestStrategy = suitableStrategies.find(s => s.name === 'Bull Put Spread') ||
                              suitableStrategies.find(s => s.name === 'Jade Lizard') ||
                              suitableStrategies[0];
                confidence = 82;
            } else if (iv > 20 && marketConditions.dailyRange > 0.5) {
                // High volatility + wide range = neutral strategies
                bestStrategy = suitableStrategies.find(s => s.name === 'Butterfly Spread') ||
                              suitableStrategies.find(s => s.name === 'Short Strangle') ||
                              suitableStrategies[0];
                confidence = 79;
            } else {
                // Default to highest win rate short-term strategy
                bestStrategy = suitableStrategies.sort((a, b) => b.winRate - a.winRate)[0];
                confidence = 75 + Math.random() * 10;
            }
            
            // Calculate optimized strikes for short-term trades
            const strikes = calculateOptimizedStrikes(bestStrategy, price, iv, marketConditions);
            
            // Calculate expected profit with frequency bonus
            const expectedProfit = calculateShortTermProfit(bestStrategy, strikes, iv, timeFactors);
            
            // Risk assessment for short-term trades
            const riskLevel = assessShortTermRisk(bestStrategy, iv, marketConditions);
            
            // Generate enhanced reasoning
            const reasoning = generateEnhancedReasoning(bestStrategy, iv, trend, price, timeFactors, marketConditions);
            
            return {
                strategy: bestStrategy,
                strikes: strikes,
                confidence: Math.round(confidence),
                expectedProfit: expectedProfit,
                riskLevel: riskLevel,
                reasoning: reasoning,
                timeFactors: timeFactors,
                marketAnalysis: {
                    currentPrice: price,
                    impliedVol: iv,
                    trend: trend,
                    support: marketConditions.support,
                    resistance: marketConditions.resistance,
                    regime: marketConditions.marketRegime,
                    dailyRange: marketConditions.dailyRange,
                    optimalEntry: timeFactors.optimalEntry,
                    expectedDuration: `${bestStrategy.optimalDTE[0]}-${bestStrategy.optimalDTE[1]} hours` + 
                                   (bestStrategy.optimalDTE[1] > 1 ? ` (${bestStrategy.optimalDTE[1]} days max)` : '')
                }
            };
        }

        function getTimeBasedFactors(hour) {
            const factors = {
                isMorning: hour >= 9 && hour <= 11,
                isMidDay: hour >= 11 && hour <= 14,
                isPowerHour: hour >= 14 && hour <= 16,
                is0DTE: new Date().getDay() === 5, // Friday for 0DTE
                optimalEntry: '',
                thetaAcceleration: 1
            };
            
            if (factors.isMorning) {
                factors.optimalEntry = 'Market Open (High Volume)';
                factors.thetaAcceleration = 1.2;
            } else if (factors.isMidDay) {
                factors.optimalEntry = 'Mid-Day (Stable Conditions)';
                factors.thetaAcceleration = 1.0;
            } else if (factors.isPowerHour) {
                factors.optimalEntry = 'Power Hour (Volatility Spike)';
                factors.thetaAcceleration = 1.5;
            } else {
                factors.optimalEntry = 'After Hours (Limited Liquidity)';
                factors.thetaAcceleration = 0.8;
            }
            
            return factors;
        }

        function calculateOptimizedStrikes(strategy, price, iv, conditions) {
            // Tighter strikes for short-term trades
            const buffer = Math.max(15, iv * 1.5); // Reduced buffer for short-term
            const tightSpread = 25; // Smaller spreads for faster profits
            
            switch(strategy.name) {
                case 'Iron Condor':
                case '0DTE Iron Condor':
                    return {
                        putShort: Math.round((price - buffer) / 5) * 5,
                        putLong: Math.round((price - buffer - tightSpread) / 5) * 5,
                        callShort: Math.round((price + buffer) / 5) * 5,
                        callLong: Math.round((price + buffer + tightSpread) / 5) * 5
                    };
                case 'Short Strangle':
                    return {
                        putShort: Math.round((price - buffer * 0.8) / 5) * 5,
                        callShort: Math.round((price + buffer * 0.8) / 5) * 5
                    };
                case 'Bull Put Spread':
                    return {
                        putShort: Math.round((price - buffer * 0.7) / 5) * 5,
                        putLong: Math.round((price - buffer * 0.7 - tightSpread) / 5) * 5
                    };
                case 'Bear Call Spread':
                    return {
                        callShort: Math.round((price + buffer * 0.7) / 5) * 5,
                        callLong: Math.round((price + buffer * 0.7 + tightSpread) / 5) * 5
                    };
                case 'Butterfly Spread':
                    return {
                        lower: Math.round((price - 15) / 5) * 5,
                        middle: Math.round(price / 5) * 5,
                        upper: Math.round((price + 15) / 5) * 5
                    };
                case 'Scalp Straddle':
                    return {
                        strike: Math.round(price / 5) * 5
                    };
                case 'Jade Lizard':
                    return {
                        putShort: Math.round((price - buffer * 0.6) / 5) * 5,
                        callShort: Math.round((price + buffer * 0.4) / 5) * 5,
                        callLong: Math.round((price + buffer * 0.4 + tightSpread) / 5) * 5
                    };
                default:
                    return {};
            }
        }

        function calculateShortTermProfit(strategy, strikes, iv, timeFactors) {
            // Enhanced profit calculation for short-term strategies
            const baseProfits = {
                'Iron Condor': 120,
                '0DTE Iron Condor': 95,
                'Short Strangle': 140,
                'Bull Put Spread': 85,
                'Bear Call Spread': 80,
                'Butterfly Spread': 70,
                'Scalp Straddle': 110,
                'Jade Lizard': 130
            };
            
            const baseProfit = baseProfits[strategy.name] || 80;
            const ivMultiplier = Math.max(0.8, iv / 20); // IV adjustment
            const thetaBonus = timeFactors.thetaAcceleration; // Time-based bonus
            const frequencyMultiplier = strategy.frequency === 'intraday' ? 1.3 : 1.1; // Frequency bonus
            
            return Math.round(baseProfit * ivMultiplier * thetaBonus * frequencyMultiplier);
        }

        function assessShortTermRisk(strategy, iv, conditions) {
            // Risk assessment specific to short-term trades
            if (strategy.name.includes('0DTE') || strategy.name === 'Scalp Straddle') {
                return iv > 25 ? 'high' : 'medium';
            } else if (strategy.riskProfile === 'low' && iv < 20) {
                return 'low';
            } else if (conditions.dailyRange > 0.6) {
                return 'high';
            } else {
                return 'medium';
            }
        }

        function generateEnhancedReasoning(strategy, iv, trend, price, timeFactors, conditions) {
            const reasons = [];
            
            // Time-specific reasoning
            if (timeFactors.is0DTE) {
                reasons.push(`🕐 0DTE Friday - Maximum theta acceleration for same-day profits`);
            } else {
                reasons.push(`⚡ ${strategy.optimalDTE[1]}-day max hold reduces overnight risk`);
            }
            
            // Strategy-specific reasoning
            if (strategy.name.includes('Iron Condor')) {
                reasons.push(`🎯 Tight ${Math.abs(strategy.name.includes('0DTE') ? 20 : 25)}pt spreads for quick 20-30% profits`);
                reasons.push(`📊 ${iv}% IV optimal for premium collection in low-vol environment`);
            } else if (strategy.name === 'Short Strangle') {
                reasons.push(`💰 High premium collection with ${Math.round((6290-6240)/price*100*100)/100}% daily range containment`);
            } else if (strategy.name.includes('Spread')) {
                reasons.push(`🛡️ Defined risk ${strategy.type} bias with ${trend} market momentum`);
            }
            
            // Market condition reasoning
            reasons.push(`🚀 ${timeFactors.optimalEntry} provides ${timeFactors.thetaAcceleration}x theta acceleration`);
            reasons.push(`📈 ${conditions.marketRegime.replace('-', ' ')} regime favors ${strategy.frequency} ${strategy.type} strategies`);
            
            // Frequency advantage
            if (strategy.frequency === 'intraday') {
                reasons.push(`🔄 Multiple setups per day possible - compound small wins`);
            } else {
                reasons.push(`📅 Daily setup frequency allows consistent income generation`);
            }
            
            return reasons;
        }

        function calculateStrikes(strategy, price, iv) {
            const buffer = iv * 2; // Volatility-based buffer
            
            switch(strategy.name) {
                case 'Iron Condor':
                    return {
                        putShort: Math.round((price - buffer) / 5) * 5,
                        putLong: Math.round((price - buffer - 50) / 5) * 5,
                        callShort: Math.round((price + buffer) / 5) * 5,
                        callLong: Math.round((price + buffer + 50) / 5) * 5
                    };
                case 'Bull Put Spread':
                    return {
                        putShort: Math.round((price - buffer) / 5) * 5,
                        putLong: Math.round((price - buffer - 50) / 5) * 5
                    };
                case 'Bear Call Spread':
                    return {
                        callShort: Math.round((price + buffer) / 5) * 5,
                        callLong: Math.round((price + buffer + 50) / 5) * 5
                    };
                case 'Short Straddle':
                    return {
                        strike: Math.round(price / 5) * 5
                    };
                case 'Butterfly Spread':
                    return {
                        lower: Math.round((price - 25) / 5) * 5,
                        middle: Math.round(price / 5) * 5,
                        upper: Math.round((price + 25) / 5) * 5
                    };
                default:
                    return {};
            }
        }

        function calculateExpectedProfit(strategy, strikes, iv) {
            // Simplified profit calculation based on strategy and IV
            const baseProfit = {
                'Iron Condor': 180,
                'Bull Put Spread': 140,
                'Bear Call Spread': 135,
                'Short Straddle': 220,
                'Butterfly Spread': 95
            };
            
            const profit = baseProfit[strategy.name] || 100;
            const ivMultiplier = iv / 20; // Higher IV = higher premium
            
            return Math.round(profit * ivMultiplier);
        }

        function generateReasoning(strategy, iv, trend, price) {
            const reasons = [];
            
            if (strategy.name === 'Iron Condor') {
                reasons.push(`IV at ${iv}% is optimal for premium collection`);
                reasons.push(`Range-bound market expected between ${marketConditions.support}-${marketConditions.resistance}`);
                reasons.push(`Historical win rate of ${strategy.winRate}% in similar conditions`);
            } else if (strategy.name === 'Bull Put Spread') {
                reasons.push(`${trend.charAt(0).toUpperCase() + trend.slice(1)} trend supports upward bias`);
                reasons.push(`Strong support at ${marketConditions.support}`);
                reasons.push(`IV at ${iv}% provides good risk/reward ratio`);
            } else if (strategy.name === 'Bear Call Spread') {
                reasons.push(`Resistance at ${marketConditions.resistance} likely to hold`);
                reasons.push(`${trend.charAt(0).toUpperCase() + trend.slice(1)} momentum may reverse`);
                reasons.push(`Premium collection favorable at current IV`);
            }
            
            return reasons;
        }

        function displayTradeSuggestion(suggestion) {
            const content = `
                <div class="suggestion-content">
                    <div class="suggestion-card">
                        <h4>📋 Recommended Strategy</h4>
                        <div class="suggestion-value">${suggestion.strategy.name}</div>
                        <p><small>${suggestion.strategy.description}</small></p>
                    </div>
                    
                    <div class="suggestion-card">
                        <h4>💰 Expected Profit</h4>
                        <div class="suggestion-value">${suggestion.expectedProfit}</div>
                        <span class="risk-level risk-${suggestion.riskLevel}">Risk: ${suggestion.riskLevel.toUpperCase()}</span>
                    </div>
                    
                    <div class="suggestion-card">
                        <h4>🎯 Confidence</h4>
                        <div class="suggestion-value">${suggestion.confidence}%</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${suggestion.confidence}%"></div>
                        </div>
                    </div>
                    
                    <div class="suggestion-card">
                        <h4>⚡ Hold Duration</h4>
                        <div class="suggestion-value">${suggestion.marketAnalysis.expectedDuration}</div>
                        <p><small>Rapid theta decay window</small></p>
                    </div>
                </div>
                
                <div class="suggestion-details">
                    <h4>📊 Strike Prices</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        ${generateStrikeDisplay(suggestion.strikes)}
                    </div>
                    
                    <h4>🧠 AI Analysis</h4>
                    <ul>
                        ${suggestion.reasoning.map(reason => `<li>• ${reason}</li>`).join('')}
                    </ul>
                    
                    <h4>📈 Market Conditions</h4>
                    <ul>
                        <li>• Current SPX: ${suggestion.marketAnalysis.currentPrice}</li>
                        <li>• Implied Volatility: ${suggestion.marketAnalysis.impliedVol}%</li>
                        <li>• Market Trend: ${suggestion.marketAnalysis.trend.charAt(0).toUpperCase() + suggestion.marketAnalysis.trend.slice(1)}</li>
                        <li>• Support: ${suggestion.marketAnalysis.support} | Resistance: ${suggestion.marketAnalysis.resistance}</li>
                    </ul>
                </div>
                
                <button class="generate-btn" onclick="generateTradeSuggestion()">🔄 Generate New Suggestion</button>
            `;
            
            document.getElementById('suggestionContent').innerHTML = content;
            console.log('Trade suggestion generated:', suggestion);
        }

        function generateStrikeDisplay(strikes) {
            let html = '';
            
            for (const [key, value] of Object.entries(strikes)) {
                const label = key.replace(/([A-Z])/g, ' $1').toLowerCase().replace(/^./, str => str.toUpperCase());
                html += `<div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                    <small>${label}</small><br>
                    <strong>${value}</strong>
                </div>`;
            }
            
            return html;
        }

        // Test Chart Function
        function testChart() {
            console.log('Testing chart...');
            const ctx = document.getElementById('testChart').getContext('2d');
            
            if (myChart) {
                myChart.destroy();
            }
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jul 7', 'Jul 8', 'Jul 9', 'Jul 10', 'Jul 11'],
                    datasets: [{
                        label: 'SPX Price',
                        data: [6235, 6243, 6277, 6290, 6260],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'S&P 500 - Last 5 Days'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 6200,
                            max: 6320
                        }
                    }
                }
            });
            console.log('Chart created successfully!');
        }

        // Test Modal Function
        function testModal() {
            console.log('Testing modal directly...');
            showTradesModal();
        }

        // Show Trades Modal
        function showTradesModal() {
            console.log('showTradesModal called');
            const modal = document.getElementById('tradesModal');
            const tableBody = document.getElementById('tradesTableBody');
            
            if (!modal) {
                console.error('Modal not found!');
                alert('Error: Modal element not found');
                return;
            }
            
            console.log('Modal found, populating data...');
            
            // Clear and populate table
            tableBody.innerHTML = '';
            
            sampleTrades.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.pnl >= 0 ? 'positive' : 'negative';
                const pnlSymbol = trade.pnl >= 0 ? '+' : '';
                const statusClass = trade.status === 'win' ? 'status-win' : 'status-loss';
                
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.strategy}</td>
                    <td><small>${trade.strikes}</small></td>
                    <td class="${pnlClass}">${pnlSymbol}$${Math.abs(trade.pnl)}</td>
                    <td><span class="${statusClass}">${trade.status.toUpperCase()}</span></td>
                `;
                tableBody.appendChild(row);
            });
            
            modal.style.display = 'block';
            console.log('Modal should be visible now');
        }

        // Close Modal
        function closeModal() {
            console.log('Closing modal');
            const modal = document.getElementById('tradesModal');
            modal.style.display = 'none';
        }

        // Update Price Test
        function updatePrice() {
            const priceElement = document.getElementById('currentPrice');
            const newPrice = (6200 + Math.random() * 120).toFixed(2);
            priceElement.textContent = newPrice;
            console.log('Price updated to:', newPrice);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('tradesModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize chart on load
        window.onload = function() {
            console.log('Page loaded, initializing...');
            testChart();
        }
    </script>
</body>
</html>