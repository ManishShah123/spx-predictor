<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPX Dashboard Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
        }

        .title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .current-price {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #3498db;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #ecf0f1;
            height: 400px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
        }

        .modal-header {
            background: #3498db;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .trades-table th {
            background: #34495e;
            color: white;
            padding: 12px 8px;
            text-align: left;
        }

        .trades-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .trades-table tr:hover {
            background-color: #f8f9fa;
        }

        .positive { color: #27ae60; font-weight: bold; }
        .negative { color: #e74c3c; font-weight: bold; }

        .status-win {
            background: #d5f4e6;
            color: #27ae60;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .status-loss {
            background: #fadbd8;
            color: #e74c3c;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .test-buttons {
            text-align: center;
            margin: 20px 0;
        }

        .test-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 0 10px;
            cursor: pointer;
        }

        .test-btn:hover {
            background: #2980b9;
        }

        .trade-suggestion {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .suggestion-header {
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .suggestion-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .suggestion-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .suggestion-card h4 {
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .suggestion-value {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .confidence-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 8px;
            margin-top: 10px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .generate-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .suggestion-details {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
        }

        .suggestion-details h4 {
            margin-bottom: 10px;
            color: #ecf0f1;
        }

        .suggestion-details ul {
            list-style: none;
            padding: 0;
        }

        .suggestion-details li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .suggestion-details li:last-child {
            border-bottom: none;
        }

        .risk-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .risk-low { background: #27ae60; }
        .risk-medium { background: #f39c12; }
        .risk-high { background: #e74c3c; }

        .chart-status {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #666;
        }

        .chart-loading { color: #3498db; }
        .chart-error { color: #e74c3c; }
        .chart-success { color: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ðŸ§ª SPX Dashboard Test Page</h1>
        
        <div class="current-price">
            <h2>Current S&P 500 Index</h2>
            <div style="font-size: 2.5em; font-weight: bold;" id="currentPrice">6,259.00</div>
            <div>-0.75 (-0.01%) Today</div>
        </div>

        <div class="test-buttons">
            <button class="test-btn" onclick="testChart()">Test Chart</button>
            <button class="test-btn" onclick="testModal()">Test Modal</button>
            <button class="test-btn" onclick="updatePrice()">Update Price</button>
        </div>

        <div class="trade-suggestion">
            <div class="suggestion-header">
                <span>ðŸŽ¯</span>
                <span>AI-Powered Next Day Trade Suggestion</span>
                <span>ðŸ¤–</span>
            </div>
            <div id="suggestionContent">
                <p>Generate a high-probability trade recommendation based on current market conditions, volatility patterns, and historical data.</p>
                <button class="generate-btn" onclick="generateTradeSuggestion()">ðŸš€ Generate Tomorrow's Trade</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">81.2%</div>
                <div class="stat-label">Prediction Accuracy</div>
            </div>
            <div class="stat-card" onclick="showPnLModal()" style="border: 3px solid #27ae60;">
                <div class="stat-value">+$18,750</div>
                <div class="stat-label">ðŸ’° Monthly P&L (CLICK ME)</div>
            </div>
            <div class="stat-card" onclick="showTradesModal()" style="border: 3px solid #e74c3c;">
                <div class="stat-value">31</div>
                <div class="stat-label">ðŸ“Š Successful Trades (CLICK ME)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">78%</div>
                <div class="stat-label">Win Rate</div>
            </div>
        </div>

        <div class="chart-container">
            <h3>ðŸ“ˆ SPX Chart - Last 7 Trading Days</h3>
            <div id="chartStatus" class="chart-status">Ready to load chart...</div>
            <div class="chart-wrapper">
                <canvas id="testChart"></canvas>
            </div>
        </div>
    </div>

    <div id="tradesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ðŸ“Š Trading History</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Recent Trades Summary</h3>
                <p><strong>Total Trades:</strong> 39 | <strong>Win Rate:</strong> 78% | <strong>Total P&L:</strong> +$18,750</p>
                
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Strategy</th>
                            <th>Strikes</th>
                            <th>P&L</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="tradesTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Monthly P&L Modal -->
    <div id="pnlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ðŸ’° Monthly P&L Breakdown - July 2025</h2>
                <button class="close" onclick="closePnLModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: #d5f4e6; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #27ae60; margin-bottom: 5px;">Total Monthly P&L</h4>
                        <div style="font-size: 1.8em; font-weight: bold; color: #27ae60;">+$18,750</div>
                    </div>
                    <div style="background: #e8f4fd; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #3498db; margin-bottom: 5px;">Trading Days</h4>
                        <div style="font-size: 1.8em; font-weight: bold; color: #3498db;">23</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #2c3e50; margin-bottom: 5px;">Avg Daily P&L</h4>
                        <div style="font-size: 1.8em; font-weight: bold; color: #2c3e50;">+$815</div>
                    </div>
                    <div style="background: #fadbd8; padding: 15px; border-radius: 10px; text-align: center;">
                        <h4 style="color: #e74c3c; margin-bottom: 5px;">Max Drawdown</h4>
                        <div style="font-size: 1.8em; font-weight: bold; color: #e74c3c;">-$1,250</div>
                    </div>
                </div>

                <h3>Daily P&L Performance</h3>
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Strategy</th>
                            <th>Strikes</th>
                            <th>Entry Time</th>
                            <th>Exit Time</th>
                            <th>Daily P&L</th>
                            <th>Running Total</th>
                        </tr>
                    </thead>
                    <tbody id="pnlTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Alpha Vantage API Configuration
        const ALPHA_VANTAGE_API_KEY = 'OPTXVKUBFL1VH71Q'; // Your real API key
        const API_BASE_URL = 'https://www.alphavantage.co/query';
        
        // Declare global chart variable
        let myChart = null;
        let realMarketData = null;
        let currentPrice = 6259.00; // Fallback price

        // Test data
        const sampleTrades = [
            { date: '2025-07-11', strategy: 'Iron Condor', strikes: '6200/6150/6320/6370', pnl: 160, status: 'win' },
            { date: '2025-07-10', strategy: 'Iron Condor', strikes: '6180/6130/6300/6350', pnl: 155, status: 'win' },
            { date: '2025-07-09', strategy: 'Butterfly', strikes: '6250/6275/6300', pnl: 135, status: 'win' },
            { date: '2025-07-08', strategy: 'Iron Condor', strikes: '6160/6110/6280/6330', pnl: -15, status: 'loss' },
            { date: '2025-07-05', strategy: 'Iron Condor', strikes: '6190/6140/6310/6360', pnl: 210, status: 'win' },
            { date: '2025-07-03', strategy: 'Straddle', strikes: '6250/6250', pnl: -430, status: 'loss' },
            { date: '2025-07-02', strategy: 'Iron Condor', strikes: '6170/6120/6290/6340', pnl: 160, status: 'win' },
            { date: '2025-06-28', strategy: 'Butterfly', strikes: '6240/6265/6290', pnl: 85, status: 'win' }
        ];

        // Monthly P&L data with detailed trade setups - NOW USING REALISTIC DATA
        let monthlyPnLData = [];

        // Initialize realistic data on page load
        function initializeRealisticData() {
            monthlyPnLData = generateRealisticPnLData();
            
            // Update summary stats based on real data
            const totalPnL = monthlyPnLData.reduce((sum, trade) => sum + trade.dailyPnL, 0);
            const winningTrades = monthlyPnLData.filter(trade => trade.dailyPnL > 0).length;
            const winRate = Math.round((winningTrades / monthlyPnLData.length) * 100);
            const avgDaily = Math.round(totalPnL / monthlyPnLData.length);
            const maxLoss = Math.min(...monthlyPnLData.map(trade => trade.dailyPnL));
            
            // Update displayed stats
            document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = `+${totalPnL.toLocaleString()}`;
            document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = winningTrades;
            document.querySelector('.stat-card:nth-child(4) .stat-value').textContent = `${winRate}%`;
            
            console.log('Realistic trading data initialized:', {
                totalPnL,
                winRate,
                avgDaily,
                maxLoss,
                trades: monthlyPnLData.length
            });
        }

        // Fetch real SPX data from Alpha Vantage
        async function fetchRealSPXData() {
            try {
                console.log('Fetching real SPX data from Alpha Vantage...');
                updateChartStatus('Connecting to Alpha Vantage API...', 'loading');
                
                // Get current quote for SPY (S&P 500 ETF as proxy for SPX)
                const quoteResponse = await fetch(`${API_BASE_URL}?function=GLOBAL_QUOTE&symbol=SPY&apikey=${ALPHA_VANTAGE_API_KEY}`);
                const quoteData = await quoteResponse.json();
                
                console.log('Alpha Vantage Quote Response:', quoteData);
                
                if (quoteData['Error Message']) {
                    throw new Error('API Error: ' + quoteData['Error Message']);
                }
                
                if (quoteData['Note']) {
                    console.warn('API Rate Limit:', quoteData['Note']);
                    updateChartStatus('API rate limit - using enhanced demo data', 'error');
                    throw new Error('API rate limit exceeded');
                }
                
                const quote = quoteData['Global Quote'];
                if (quote && quote['05. price']) {
                    // Convert SPY to approximate SPX (SPY * 10)
                    const spyPrice = parseFloat(quote['05. price']);
                    currentPrice = spyPrice * 10; // Approximate SPX conversion
                    const change = parseFloat(quote['09. change']) * 10;
                    const changePercent = quote['10. change percent'].replace('%', '');
                    
                    console.log('Real market data loaded:', {
                        spy_price: spyPrice,
                        estimated_spx: currentPrice,
                        change: change,
                        change_percent: changePercent
                    });
                    
                    // Update current price display
                    document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
                    const changeDisplay = change >= 0 ? 
                        `+${change.toFixed(2)} (+${changePercent}%)` : 
                        `${change.toFixed(2)} (${changePercent}%)`;
                    document.querySelector('.current-price div:last-child').textContent = 
                        changeDisplay + ' Today (Live via Alpha Vantage)';
                    
                    updateChartStatus('Loading historical data...', 'loading');
                } else {
                    throw new Error('No quote data available');
                }
                
                // Get historical data (daily) - wait a moment to respect rate limits
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const historyResponse = await fetch(`${API_BASE_URL}?function=TIME_SERIES_DAILY&symbol=SPY&apikey=${ALPHA_VANTAGE_API_KEY}`);
                const historyData = await historyResponse.json();
                
                console.log('Alpha Vantage Historical Response:', historyData);
                
                if (historyData['Time Series (Daily)']) {
                    const timeSeries = historyData['Time Series (Daily)'];
                    const dates = Object.keys(timeSeries).slice(0, 7).reverse(); // Last 7 days, chronological order
                    
                    realMarketData = {
                        labels: dates.map(date => {
                            const d = new Date(date);
                            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        }),
                        prices: dates.map(date => parseFloat(timeSeries[date]['4. close']) * 10) // Convert SPY to SPX
                    };
                    
                    console.log('Real historical data loaded:', realMarketData);
                    return true;
                } else if (historyData['Note']) {
                    console.warn('Historical data rate limit:', historyData['Note']);
                    throw new Error('Rate limit for historical data');
                } else {
                    throw new Error('No historical time series data available');
                }
                
            } catch (error) {
                console.error('Error fetching real SPX data:', error);
                
                // Enhanced fallback with realistic recent data
                const today = new Date();
                const basePrice = 5850; // Current SPX range
                realMarketData = {
                    labels: [],
                    prices: []
                };
                
                // Generate 7 days of realistic data
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    
                    // Skip weekends for realistic trading days
                    if (date.getDay() !== 0 && date.getDay() !== 6) {
                        realMarketData.labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                        // Generate realistic price movement
                        const priceVariation = (Math.random() - 0.5) * 100; // +/- $50 daily moves
                        realMarketData.prices.push(basePrice + priceVariation + (Math.random() * 20));
                    }
                }
                
                // Ensure we have exactly 5 trading days
                while (realMarketData.labels.length < 5) {
                    const lastDate = new Date();
                    lastDate.setDate(lastDate.getDate() - realMarketData.labels.length);
                    realMarketData.labels.push(lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    realMarketData.prices.push(basePrice + (Math.random() - 0.5) * 100);
                }
                
                // Set current price from last data point
                currentPrice = realMarketData.prices[realMarketData.prices.length - 1];
                document.getElementById('currentPrice').textContent = currentPrice.toFixed(2);
                
                // Show user-friendly message
                if (error.message.includes('rate limit')) {
                    updateChartStatus('API rate limit reached - using realistic demo data', 'error');
                    setTimeout(() => {
                        updateChartStatus('Get unlimited API calls with Alpha Vantage premium', 'loading');
                    }, 4000);
                } else {
                    updateChartStatus('Using enhanced demo data - API connection failed', 'error');
                }
                
                return false;
            }
        }

        // Generate realistic P&L data based on market conditions
        function generateRealisticPnLData() {
            const strategies = [
                'Iron Condor', 'Butterfly Spread', 'Bull Put Spread', 
                'Bear Call Spread', 'Short Strangle', '0DTE Iron Condor', 'Jade Lizard'
            ];
            const baseDate = new Date();
            const data = [];
            let runningTotal = 15000; // Starting balance
            
            // Generate 20 trading days of data
            for (let i = 25; i >= 0; i--) {
                const date = new Date(baseDate);
                date.setDate(date.getDate() - i);
                
                // Skip weekends
                if (date.getDay() === 0 || date.getDay() === 6) continue;
                
                const strategy = strategies[Math.floor(Math.random() * strategies.length)];
                const isWin = Math.random() > 0.22; // 78% win rate
                
                let dailyPnL;
                if (isWin) {
                    // Winning trades: $50-$300 based on strategy type
                    if (strategy.includes('0DTE')) {
                        dailyPnL = Math.floor(Math.random() * 150) + 50; // $50-$200 for 0DTE
                    } else if (strategy === 'Iron Condor') {
                        dailyPnL = Math.floor(Math.random() * 200) + 100; // $100-$300 for Iron Condors
                    } else {
                        dailyPnL = Math.floor(Math.random() * 180) + 70; // $70-$250 for others
                    }
                } else {
                    // Losing trades: -$100 to -$500 based on strategy risk
                    if (strategy === 'Short Strangle') {
                        dailyPnL = -(Math.floor(Math.random() * 400) + 200); // Higher risk
                    } else {
                        dailyPnL = -(Math.floor(Math.random() * 250) + 100); // Defined risk
                    }
                }
                
                runningTotal += dailyPnL;
                
                // Generate realistic strikes based on current market price
                const strikes = generateRealisticStrikes(strategy, currentPrice);
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    strategy: strategy,
                    strikes: strikes,
                    entryTime: getRandomTime('9:30', '11:00'),
                    exitTime: getRandomTime('13:00', '15:45'),
                    dailyPnL: dailyPnL,
                    runningTotal: runningTotal
                });
            }
            
            return data.reverse(); // Most recent first
        }
        
        function generateRealisticStrikes(strategy, price) {
            // Use current market price for realistic strike generation
            const currentLevel = Math.round(price);
            const buffer = 25 + Math.random() * 35; // $25-60 buffer based on volatility
            const spread = 25; // $25 spread width for defined risk
            
            switch(strategy) {
                case 'Iron Condor':
                case '0DTE Iron Condor':
                    const putShort = Math.round((currentLevel - buffer) / 5) * 5;
                    const putLong = Math.round((putShort - spread) / 5) * 5;
                    const callShort = Math.round((currentLevel + buffer) / 5) * 5;
                    const callLong = Math.round((callShort + spread) / 5) * 5;
                    return `${putShort}/${putLong}/${callShort}/${callLong}`;
                    
                case 'Bull Put Spread':
                    const putShortBull = Math.round((currentLevel - buffer) / 5) * 5;
                    const putLongBull = Math.round((putShortBull - spread) / 5) * 5;
                    return `${putShortBull}/${putLongBull}`;
                    
                case 'Bear Call Spread':
                    const callShortBear = Math.round((currentLevel + buffer) / 5) * 5;
                    const callLongBear = Math.round((callShortBear + spread) / 5) * 5;
                    return `${callShortBear}/${callLongBear}`;
                    
                case 'Butterfly Spread':
                    const lowerWing = Math.round((currentLevel - 25) / 5) * 5;
                    const middle = Math.round(currentLevel / 5) * 5;
                    const upperWing = Math.round((currentLevel + 25) / 5) * 5;
                    return `${lowerWing}/${middle}/${upperWing}`;
                    
                case 'Short Strangle':
                    const putStrike = Math.round((currentLevel - buffer * 0.8) / 5) * 5;
                    const callStrike = Math.round((currentLevel + buffer * 0.8) / 5) * 5;
                    return `${putStrike}/${callStrike}`;
                    
                case 'Jade Lizard':
                    const putJade = Math.round((currentLevel - buffer * 0.6) / 5) * 5;
                    const callShortJade = Math.round((currentLevel + buffer * 0.4) / 5) * 5;
                    const callLongJade = Math.round((callShortJade + spread) / 5) * 5;
                    return `${putJade}/${callShortJade}/${callLongJade}`;
                    
                default:
                    return `${Math.round(currentLevel / 5) * 5}`;
            }
        }
        
        function getRandomTime(start, end) {
            const startTime = start.split(':');
            const endTime = end.split(':');
            const startMinutes = parseInt(startTime[0]) * 60 + parseInt(startTime[1]);
            const endMinutes = parseInt(endTime[0]) * 60 + parseInt(endTime[1]);
            const randomMinutes = Math.floor(Math.random() * (endMinutes - startMinutes)) + startMinutes;
            
            const hours = Math.floor(randomMinutes / 60);
            const minutes = randomMinutes % 60;
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // Update dashboard stats dynamically
        function updateDashboardStats() {
            const freshData = generateRealisticPnLData();
            const totalPnL = freshData.reduce((sum, trade) => sum + trade.dailyPnL, 0);
            const winningTrades = freshData.filter(trade => trade.dailyPnL > 0).length;
            const winRate = Math.round((winningTrades / freshData.length) * 100);
            
            // Update main dashboard stats
            const statCards = document.querySelectorAll('.stat-card .stat-value');
            if (statCards.length >= 4) {
                statCards[1].textContent = `+${totalPnL.toLocaleString()}`; // Monthly P&L
                statCards[2].textContent = winningTrades; // Successful trades
                statCards[3].textContent = `${winRate}%`; // Win rate
            }
            
            console.log('Dashboard stats updated:', { totalPnL, winningTrades, winRate });
        }

        // Chart status helper function
        function updateChartStatus(message, type = 'loading') {
            const statusElement = document.getElementById('chartStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `chart-status chart-${type}`;
            }
        }

        // Test Chart Function - ENHANCED WITH REAL DATA
        async function testChart() {
            console.log('Testing chart with real data...');
            updateChartStatus('Loading real market data...', 'loading');
            
            try {
                // Try to fetch real data first
                const realDataLoaded = await fetchRealSPXData();
                
                const canvas = document.getElementById('testChart');
                if (!canvas) {
                    throw new Error('Canvas element not found');
                }
                
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    throw new Error('Cannot get 2D context');
                }
                
                // Destroy existing chart if it exists
                if (myChart) {
                    myChart.destroy();
                    myChart = null;
                }
                
                const chartTitle = realDataLoaded ? 
                    'S&P 500 (SPY) - Real Market Data via Alpha Vantage' : 
                    'S&P 500 - Demo Data (Get API key for real data)';
                
                // Create new chart with real or demo data
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: realMarketData.labels,
                        datasets: [{
                            label: 'SPX Price',
                            data: realMarketData.prices,
                            borderColor: realDataLoaded ? '#27ae60' : '#3498db',
                            backgroundColor: realDataLoaded ? 'rgba(39, 174, 96, 0.1)' : 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: realDataLoaded ? '#27ae60' : '#3498db',
                            pointBorderColor: realDataLoaded ? '#229954' : '#2980b9',
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: chartTitle,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                color: realDataLoaded ? '#27ae60' : '#3498db'
                            },
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: Math.min(...realMarketData.prices) - 20,
                                max: Math.max(...realMarketData.prices) + 20,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '

        // Test Modal Function
        function testModal() {
            console.log('Testing modal directly...');
            showTradesModal();
        }

        // Show Trades Modal
        function showTradesModal() {
            console.log('showTradesModal called');
            const modal = document.getElementById('tradesModal');
            const tableBody = document.getElementById('tradesTableBody');
            
            if (!modal) {
                console.error('Modal not found!');
                alert('Error: Modal element not found');
                return;
            }
            
            console.log('Modal found, populating data...');
            
            // Clear and populate table
            tableBody.innerHTML = '';
            
            sampleTrades.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.pnl >= 0 ? 'positive' : 'negative';
                const pnlSymbol = trade.pnl >= 0 ? '+' : '';
                const statusClass = trade.status === 'win' ? 'status-win' : 'status-loss';
                
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.strategy}</td>
                    <td><small>${trade.strikes}</small></td>
                    <td class="${pnlClass}">${pnlSymbol}$${Math.abs(trade.pnl)}</td>
                    <td><span class="${statusClass}">${trade.status.toUpperCase()}</span></td>
                `;
                tableBody.appendChild(row);
            });
            
            modal.style.display = 'block';
            console.log('Modal should be visible now');
        }

        // Show Monthly P&L Modal
        function showPnLModal() {
            console.log('showPnLModal called');
            const modal = document.getElementById('pnlModal');
            const tableBody = document.getElementById('pnlTableBody');
            
            if (!modal) {
                console.error('P&L Modal not found!');
                alert('Error: P&L Modal element not found');
                return;
            }
            
            console.log('P&L Modal found, populating data...');
            
            // Clear and populate table
            tableBody.innerHTML = '';
            
            monthlyPnLData.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.dailyPnL >= 0 ? 'positive' : 'negative';
                const pnlSymbol = trade.dailyPnL >= 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.strategy}</td>
                    <td><small>${trade.strikes}</small></td>
                    <td><small>${trade.entryTime}</small></td>
                    <td><small>${trade.exitTime}</small></td>
                    <td class="${pnlClass}"><strong>${pnlSymbol}${Math.abs(trade.dailyPnL)}</strong></td>
                    <td style="color: #2c3e50; font-weight: bold;">${trade.runningTotal.toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
            
            modal.style.display = 'block';
            console.log('P&L Modal should be visible now');
        }

        // Close P&L Modal
        function closePnLModal() {
            console.log('Closing P&L modal');
            const modal = document.getElementById('pnlModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Update Price Test
        function updatePrice() {
            const priceElement = document.getElementById('currentPrice');
            if (priceElement) {
                const newPrice = (6200 + Math.random() * 120).toFixed(2);
                priceElement.textContent = newPrice;
                console.log('Price updated to:', newPrice);
            }
        }

        // Generate Trade Suggestion
        function generateTradeSuggestion() {
            console.log('Generating trade suggestion...');
            
            const suggestionContent = document.getElementById('suggestionContent');
            if (!suggestionContent) return;
            
            // Simulate loading
            suggestionContent.innerHTML = '<p>ðŸ§  Analyzing market conditions... Please wait.</p>';
            
            setTimeout(() => {
                suggestionContent.innerHTML = `
                    <div class="suggestion-content">
                        <div class="suggestion-card">
                            <h4>ðŸ“‹ Recommended Strategy</h4>
                            <div class="suggestion-value">Iron Condor</div>
                            <p><small>Short-term premium collection with quick theta decay</small></p>
                        </div>
                        
                        <div class="suggestion-card">
                            <h4>ðŸ’° Expected Profit</h4>
                            <div class="suggestion-value">$145</div>
                            <span class="risk-level risk-low">Risk: LOW</span>
                        </div>
                        
                        <div class="suggestion-card">
                            <h4>ðŸŽ¯ Confidence</h4>
                            <div class="suggestion-value">85%</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 85%"></div>
                            </div>
                        </div>
                        
                        <div class="suggestion-card">
                            <h4>âš¡ Hold Duration</h4>
                            <div class="suggestion-value">2-3 hours</div>
                            <p><small>Rapid theta decay window</small></p>
                        </div>
                    </div>
                    
                    <div class="suggestion-details">
                        <h4>ðŸ“Š Strike Prices</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Put Short</small><br><strong>6235</strong>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Put Long</small><br><strong>6210</strong>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Call Short</small><br><strong>6285</strong>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Call Long</small><br><strong>6310</strong>
                            </div>
                        </div>
                        
                        <h4>ðŸ§  AI Analysis</h4>
                        <ul>
                            <li>â€¢ 16.8% IV optimal for premium collection in low-vol environment</li>
                            <li>â€¢ Market Open (High Volume) provides 1.2x theta acceleration</li>
                            <li>â€¢ Range-bound market expected between 6240-6290</li>
                            <li>â€¢ Daily setup frequency allows consistent income generation</li>
                        </ul>
                    </div>
                    
                    <button class="generate-btn" onclick="generateTradeSuggestion()">ðŸ”„ Generate New Suggestion</button>
                `;
            }, 2000);
        }

        // Close Modal
        function closeModal() {
            console.log('Closing modal');
            const modal = document.getElementById('tradesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const tradesModal = document.getElementById('tradesModal');
            const pnlModal = document.getElementById('pnlModal');
            
            if (event.target === tradesModal) {
                closeModal();
            } else if (event.target === pnlModal) {
                closePnLModal();
            }
        }

        // Initialize chart and data on load
        window.onload = async function() {
            console.log('Page loaded, initializing with real market data...');
            
            try {
                // Load chart with real data first
                await testChart();
                
                // Then initialize realistic P&L data based on the current price
                initializeRealisticData();
                
                console.log('Dashboard fully initialized with current price:', currentPrice);
            } catch (error) {
                console.error('Error during initialization:', error);
                
                // Fallback initialization
                initializeRealisticData();
            }
        }
    </script>
</body>
</html> + value.toLocaleString();
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
                if (realDataLoaded) {
                    updateChartStatus('Real market data loaded successfully!', 'success');
                } else {
                    updateChartStatus('Demo data - Visit alphavantage.co for free API key', 'loading');
                }
                
                console.log('Chart created successfully!');
                
                // Hide status message after 3 seconds
                setTimeout(() => {
                    updateChartStatus('', 'success');
                }, 3000);
                
            } catch (error) {
                console.error('Chart creation failed:', error);
                updateChartStatus(`Chart error: ${error.message}`, 'error');
            }
        }

        // Test Modal Function
        function testModal() {
            console.log('Testing modal directly...');
            showTradesModal();
        }

        // Show Trades Modal
        function showTradesModal() {
            console.log('showTradesModal called');
            const modal = document.getElementById('tradesModal');
            const tableBody = document.getElementById('tradesTableBody');
            
            if (!modal) {
                console.error('Modal not found!');
                alert('Error: Modal element not found');
                return;
            }
            
            console.log('Modal found, populating data...');
            
            // Clear and populate table
            tableBody.innerHTML = '';
            
            sampleTrades.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.pnl >= 0 ? 'positive' : 'negative';
                const pnlSymbol = trade.pnl >= 0 ? '+' : '';
                const statusClass = trade.status === 'win' ? 'status-win' : 'status-loss';
                
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.strategy}</td>
                    <td><small>${trade.strikes}</small></td>
                    <td class="${pnlClass}">${pnlSymbol}$${Math.abs(trade.pnl)}</td>
                    <td><span class="${statusClass}">${trade.status.toUpperCase()}</span></td>
                `;
                tableBody.appendChild(row);
            });
            
            modal.style.display = 'block';
            console.log('Modal should be visible now');
        }

        // Show Monthly P&L Modal
        function showPnLModal() {
            console.log('showPnLModal called');
            const modal = document.getElementById('pnlModal');
            const tableBody = document.getElementById('pnlTableBody');
            
            if (!modal) {
                console.error('P&L Modal not found!');
                alert('Error: P&L Modal element not found');
                return;
            }
            
            console.log('P&L Modal found, populating data...');
            
            // Clear and populate table
            tableBody.innerHTML = '';
            
            monthlyPnLData.forEach(trade => {
                const row = document.createElement('tr');
                const pnlClass = trade.dailyPnL >= 0 ? 'positive' : 'negative';
                const pnlSymbol = trade.dailyPnL >= 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>${trade.strategy}</td>
                    <td><small>${trade.strikes}</small></td>
                    <td><small>${trade.entryTime}</small></td>
                    <td><small>${trade.exitTime}</small></td>
                    <td class="${pnlClass}"><strong>${pnlSymbol}${Math.abs(trade.dailyPnL)}</strong></td>
                    <td style="color: #2c3e50; font-weight: bold;">${trade.runningTotal.toLocaleString()}</td>
                `;
                tableBody.appendChild(row);
            });
            
            modal.style.display = 'block';
            console.log('P&L Modal should be visible now');
        }

        // Close P&L Modal
        function closePnLModal() {
            console.log('Closing P&L modal');
            const modal = document.getElementById('pnlModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Update Price Test
        function updatePrice() {
            const priceElement = document.getElementById('currentPrice');
            if (priceElement) {
                const newPrice = (6200 + Math.random() * 120).toFixed(2);
                priceElement.textContent = newPrice;
                console.log('Price updated to:', newPrice);
            }
        }

        // Generate Trade Suggestion
        function generateTradeSuggestion() {
            console.log('Generating trade suggestion...');
            
            const suggestionContent = document.getElementById('suggestionContent');
            if (!suggestionContent) return;
            
            // Simulate loading
            suggestionContent.innerHTML = '<p>ðŸ§  Analyzing market conditions... Please wait.</p>';
            
            setTimeout(() => {
                suggestionContent.innerHTML = `
                    <div class="suggestion-content">
                        <div class="suggestion-card">
                            <h4>ðŸ“‹ Recommended Strategy</h4>
                            <div class="suggestion-value">Iron Condor</div>
                            <p><small>Short-term premium collection with quick theta decay</small></p>
                        </div>
                        
                        <div class="suggestion-card">
                            <h4>ðŸ’° Expected Profit</h4>
                            <div class="suggestion-value">$145</div>
                            <span class="risk-level risk-low">Risk: LOW</span>
                        </div>
                        
                        <div class="suggestion-card">
                            <h4>ðŸŽ¯ Confidence</h4>
                            <div class="suggestion-value">85%</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 85%"></div>
                            </div>
                        </div>
                        
                        <div class="suggestion-card">
                            <h4>âš¡ Hold Duration</h4>
                            <div class="suggestion-value">2-3 hours</div>
                            <p><small>Rapid theta decay window</small></p>
                        </div>
                    </div>
                    
                    <div class="suggestion-details">
                        <h4>ðŸ“Š Strike Prices</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Put Short</small><br><strong>6235</strong>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Put Long</small><br><strong>6210</strong>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Call Short</small><br><strong>6285</strong>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                                <small>Call Long</small><br><strong>6310</strong>
                            </div>
                        </div>
                        
                        <h4>ðŸ§  AI Analysis</h4>
                        <ul>
                            <li>â€¢ 16.8% IV optimal for premium collection in low-vol environment</li>
                            <li>â€¢ Market Open (High Volume) provides 1.2x theta acceleration</li>
                            <li>â€¢ Range-bound market expected between 6240-6290</li>
                            <li>â€¢ Daily setup frequency allows consistent income generation</li>
                        </ul>
                    </div>
                    
                    <button class="generate-btn" onclick="generateTradeSuggestion()">ðŸ”„ Generate New Suggestion</button>
                `;
            }, 2000);
        }

        // Close Modal
        function closeModal() {
            console.log('Closing modal');
            const modal = document.getElementById('tradesModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const tradesModal = document.getElementById('tradesModal');
            const pnlModal = document.getElementById('pnlModal');
            
            if (event.target === tradesModal) {
                closeModal();
            } else if (event.target === pnlModal) {
                closePnLModal();
            }
        }

        // Initialize chart on load
        window.onload = function() {
            console.log('Page loaded, initializing...');
            testChart();
        }
    </script>
</body>
</html>