// Authentication handler
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is already logged in
    auth.onAuthStateChanged(function(user) {
        if (user && window.location.pathname.includes('dashboard.html')) {
            // User is signed in and on dashboard - this is correct
            return;
        } else if (user && !window.location.pathname.includes('dashboard.html')) {
            // User is signed in but not on dashboard - redirect
            window.location.href = 'dashboard.html';
        } else if (!user && window.location.pathname.includes('dashboard.html')) {
            // User is not signed in but trying to access dashboard - redirect to login
            window.location.href = 'login.html';
        }
    });

    // Login form handler
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }

    // Signup form handler
    const signupForm = document.getElementById('signupForm');
    if (signupForm) {
        signupForm.addEventListener('submit', handleSignup);
    }

    // Google auth handlers
    const googleLogin = document.getElementById('googleLogin');
    const googleSignup = document.getElementById('googleSignup');
    
    if (googleLogin) {
        googleLogin.addEventListener('click', handleGoogleAuth);
    }
    
    if (googleSignup) {
        googleSignup.addEventListener('click', handleGoogleAuth);
    }
});

async function handleLogin(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    try {
        loadingOverlay.style.display = 'flex';
        
        // For demo purposes, simulate login without Firebase
        if (email && password) {
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                window.location.href = 'dashboard.html';
            }, 1500);
        } else {
            throw new Error('Please fill in all fields');
        }
        
        // Uncomment this for real Firebase authentication:
        /*
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        console.log('User signed in:', userCredential.user);
        window.location.href = 'dashboard.html';
        */
        
    } catch (error) {
        loadingOverlay.style.display = 'none';
        showError('Login failed: ' + error.message);
    }
}

async function handleSignup(e) {
    e.preventDefault();
    
    const fullName = document.getElementById('fullName').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const tradingExperience = document.getElementById('tradingExperience').value;
    const terms = document.getElementById('terms').checked;
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Validation
    if (password !== confirmPassword) {
        showError('Passwords do not match');
        return;
    }
    
    if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
    }
    
    if (!terms) {
        showError('Please accept the terms and conditions');
        return;
    }
    
    try {
        loadingOverlay.style.display = 'flex';
        
        // For demo purposes, simulate signup without Firebase
        if (fullName && email && password && tradin